const Groq = require('groq-sdk');

// Initialize Groq client
const groq = new Groq({
  apiKey: process.env.GROQ_API_KEY,
});

async function generateSOAPNote(transcript) {
  try {
    console.log('‚ö° Generating SOAP note with Groq...');
    
    const completion = await groq.chat.completions.create({
      model: 'llama-3.3-70b-versatile',  // Updated to current model
      messages: [
        {
          role: 'system',
          content: 'You are an expert medical scribe assistant. Generate clear, professional SOAP notes from clinical encounter transcripts. Use proper medical terminology and formatting.'
        },
        {
          role: 'user',
          content: `Convert the following clinical encounter transcript into a structured SOAP note.

TRANSCRIPT:
${transcript}

Generate a properly formatted SOAP note with these sections:
- SUBJECTIVE (S): Patient's complaints, symptoms, history of present illness
- OBJECTIVE (O): Vital signs, physical examination findings, test results
- ASSESSMENT (A): Diagnosis or clinical impression
- PLAN (P): Treatment plan, medications, follow-up instructions

Use professional medical documentation format.`
        }
      ],
      max_tokens: 2000,
      temperature: 0.3, // Lower temperature for more consistent medical documentation
    });

    const soapNote = completion.choices[0].message.content;
    
    console.log('‚úÖ SOAP note generated successfully');
    console.log('   Model:', completion.model);
    console.log('   Length:', soapNote.length, 'characters');
    
    return {
      success: true,
      soapNote: soapNote,
      model: completion.model,
      usage: completion.usage,
      provider: 'groq',
    };
  } catch (error) {
    console.error('‚ùå SOAP generation error:', error.message);
    return {
      success: false,
      error: error.message,
    };
  }
}

async function saveNote(noteData) {
  // Mock storage for now - will implement SmartBuckets when deployed to Raindrop
  console.log('üíæ Note saved (mock storage):', {
    timestamp: new Date().toISOString(),
    noteLength: noteData.soapNote?.length || 0,
  });
  
  return {
    success: true,
    noteId: `note_${Date.now()}`,
    storage: 'local-mock',
  };
}

module.exports = { generateSOAPNote, saveNote };
